<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Realtime Dual Timer Multi User ‚è±Ô∏è</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes pulse { 
      0%, 100% { transform: scale(1); } 
      50% { transform: scale(1.05); } 
    }
    .pulse-animation { 
      animation: pulse 1.5s infinite; 
    }
    .timer-display { 
      font-family: 'Courier New', monospace; 
      letter-spacing: 2px; 
    }
    .timer-ended {
      color: #ef4444;
    }
    .config-panel {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .firebase-steps {
      background: rgba(255,255,255,0.1);
      border-left: 4px solid #fbbf24;
    }
  </style>
  
  <!-- Feather Icons -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col items-center justify-center p-4">
  
  <!-- Panel Konfigurasi Firebase -->
  <div id="firebaseConfigPanel" class="config-panel text-white p-6 rounded-2xl shadow-xl mb-8 w-full max-w-4xl">
    <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Konfigurasi Firebase</h2>
    <p class="mb-4">Isi dengan data dari Firebase Console project Anda:</p>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block mb-1 text-sm">apiKey:</label>
        <input type="text" id="apiKey" placeholder="AIzaSyB..." class="w-full p-2 rounded bg-white bg-opacity-20 text-white placeholder-gray-200 border border-white border-opacity-30">
      </div>
      <div>
        <label class="block mb-1 text-sm">authDomain:</label>
        <input type="text" id="authDomain" placeholder="project-id.firebaseapp.com" class="w-full p-2 rounded bg-white bg-opacity-20 text-white placeholder-gray-200 border border-white border-opacity-30">
      </div>
      <div>
        <label class="block mb-1 text-sm">databaseURL:</label>
        <input type="text" id="databaseURL" placeholder="https://project-id.firebaseio.com" class="w-full p-2 rounded bg-white bg-opacity-20 text-white placeholder-gray-200 border border-white border-opacity-30">
      </div>
      <div>
        <label class="block mb-1 text-sm">projectId:</label>
        <input type="text" id="projectId" placeholder="project-id" class="w-full p-2 rounded bg-white bg-opacity-20 text-white placeholder-gray-200 border border-white border-opacity-30">
      </div>
      <div>
        <label class="block mb-1 text-sm">storageBucket:</label>
        <input type="text" id="storageBucket" placeholder="project-id.appspot.com" class="w-full p-2 rounded bg-white bg-opacity-20 text-white placeholder-gray-200 border border-white border-opacity-30">
      </div>
      <div>
        <label class="block mb-1 text-sm">messagingSenderId:</label>
        <input type="text" id="messagingSenderId" placeholder="123456789" class="w-full p-2 rounded bg-white bg-opacity-20 text-white placeholder-gray-200 border border-white border-opacity-30">
      </div>
      <div class="md:col-span-2">
        <label class="block mb-1 text-sm">appId:</label>
        <input type="text" id="appId" placeholder="1:123456789:web:abc123def456" class="w-full p-2 rounded bg-white bg-opacity-20 text-white placeholder-gray-200 border border-white border-opacity-30">
      </div>
    </div>
    
    <div class="flex gap-4 mb-4">
      <button id="saveConfig" class="flex-1 bg-white text-purple-600 px-6 py-3 rounded-lg font-bold hover:bg-gray-100 transition duration-200">
        üíæ Simpan Konfigurasi
      </button>
      <button id="testConnection" class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-600 transition duration-200">
        üîÑ Test Koneksi
      </button>
    </div>

    <!-- Panduan Firebase Rules -->
    <div class="firebase-steps p-4 rounded mb-4">
      <h3 class="font-bold text-yellow-300 mb-2">‚ö†Ô∏è PERBAIKI FIREBASE RULES DULU!</h3>
      <p class="text-sm mb-2">Error PERMISSION_DENIED berarti aturan keamanan database perlu diperbaiki:</p>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div>
          <p class="font-semibold">Langkah-langkah:</p>
          <ol class="list-decimal list-inside mt-1 space-y-1">
            <li>Buka <a href="https://console.firebase.google.com/" target="_blank" class="underline">Firebase Console</a></li>
            <li>Pilih project Anda</li>
            <li>Klik <strong>Realtime Database</strong> di sidebar</li>
            <li>Pilih tab <strong>Rules</strong> (bukan Data)</li>
            <li>Ganti rules dengan kode di sebelah ‚Üí</li>
            <li>Klik <strong>Publish</strong></li>
          </ol>
        </div>
        
        <div>
          <p class="font-semibold">Kode Rules yang Benar:</p>
          <code class="text-xs block mt-1 bg-black bg-opacity-30 p-2 rounded whitespace-pre overflow-x-auto">
{
  "rules": {
    ".read": true,
    ".write": true
  }
}</code>
          <p class="text-xs mt-1 text-yellow-200">‚ö†Ô∏è Untuk development saja. Untuk production, gunakan rules yang lebih ketat.</p>
        </div>
      </div>
    </div>

    <!-- Cara mendapatkan config -->
    <div class="bg-white bg-opacity-10 p-4 rounded">
      <p class="font-semibold mb-2">üìù Cara mendapatkan config Firebase:</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div>
          <p class="font-semibold text-yellow-300">Jika belum punya web app:</p>
          <ol class="list-decimal list-inside space-y-1">
            <li>Buka Project Settings</li>
            <li>Scroll ke "Your apps"</li>
            <li>Klik icon <strong>„Äà/„Äâ</strong> (Web)</li>
            <li>Register app nama "Timer App"</li>
            <li>Copy config yang muncul</li>
          </ol>
        </div>
        <div>
          <p class="font-semibold text-yellow-300">Jika sudah punya web app:</p>
          <ol class="list-decimal list-inside space-y-1">
            <li>Buka Project Settings</li>
            <li>Scroll ke "Your apps"</li>
            <li>Klik web app yang sudah ada</li>
            <li>Copy config dari "Firebase SDK snippet"</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Container Timer (Awalnya Disembunyikan) -->
  <div id="timerContainer" class="hidden w-full">
    <div class="max-w-4xl w-full text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">Realtime Dual Timer</h1>
      <p class="text-gray-600 dark:text-gray-300">Multi-user timer dengan sinkronisasi realtime</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-6xl">
      <!-- TIMER 1 -->
      <div id="timer1" class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden border-2 border-indigo-200 dark:border-indigo-800">
        <div class="bg-indigo-600 p-6 text-center">
          <h1 class="text-2xl font-bold text-white">Timer #1</h1>
          <p class="text-indigo-100 mt-1">User 1</p>
        </div>
        <div class="p-8 text-center">
          <div class="text-gray-500 dark:text-gray-300 mb-3 userLabel">User: -</div>
          <div class="timer-display text-7xl font-bold text-gray-800 dark:text-white mb-6">15:00</div>

          <div class="flex justify-center space-x-4 mb-6">
            <button class="resetBtn bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full shadow-lg transition duration-200 flex items-center">
              <i data-feather="refresh-cw" class="inline mr-2"></i> Reset
            </button>
            <button class="settingsBtn bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white px-6 py-3 rounded-full shadow-lg transition duration-200 flex items-center">
              <i data-feather="settings" class="inline mr-2"></i> Settings
            </button>
          </div>

          <div class="settingsPanel bg-gray-50 dark:bg-gray-700 p-6 rounded-xl mt-4 hidden">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">User Settings</h3>
            <div class="mb-4 text-left">
              <label class="block mb-1 text-gray-700 dark:text-gray-300">Username:</label>
              <input type="text" placeholder="contoh: user1" class="usernameInput w-full px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-800 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
              <p class="text-xs text-gray-500 mt-1">Gunakan username sederhana tanpa spasi</p>
            </div>
            <div class="mb-4 text-left">
              <label class="block mb-1 text-gray-700 dark:text-gray-300">Durasi (menit):</label>
              <input type="number" min="1" max="120" value="15" class="minutesInput w-full px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-800 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button class="saveUserBtn w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-md font-medium transition duration-200">Simpan & Gunakan</button>
          </div>
        </div>
      </div>

      <!-- TIMER 2 -->
      <div id="timer2" class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden border-2 border-green-200 dark:border-green-800">
        <div class="bg-green-600 p-6 text-center">
          <h1 class="text-2xl font-bold text-white">Timer #2</h1>
          <p class="text-green-100 mt-1">User 2</p>
        </div>
        <div class="p-8 text-center">
          <div class="text-gray-500 dark:text-gray-300 mb-3 userLabel">User: -</div>
          <div class="timer-display text-7xl font-bold text-gray-800 dark:text-white mb-6">15:00</div>

          <div class="flex justify-center space-x-4 mb-6">
            <button class="resetBtn bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-full shadow-lg transition duration-200 flex items-center">
              <i data-feather="refresh-cw" class="inline mr-2"></i> Reset
            </button>
            <button class="settingsBtn bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white px-6 py-3 rounded-full shadow-lg transition duration-200 flex items-center">
              <i data-feather="settings" class="inline mr-2"></i> Settings
            </button>
          </div>

          <div class="settingsPanel bg-gray-50 dark:bg-gray-700 p-6 rounded-xl mt-4 hidden">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">User Settings</h3>
            <div class="mb-4 text-left">
              <label class="block mb-1 text-gray-700 dark:text-gray-300">Username:</label>
              <input type="text" placeholder="contoh: user2" class="usernameInput w-full px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-800 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-green-500 focus:border-green-500">
              <p class="text-xs text-gray-500 mt-1">Gunakan username sederhana tanpa spasi</p>
            </div>
            <div class="mb-4 text-left">
              <label class="block mb-1 text-gray-700 dark:text-gray-300">Durasi (menit):</label>
              <input type="number" min="1" max="120" value="15" class="minutesInput w-full px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-800 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-green-500 focus:border-green-500">
            </div>
            <button class="saveUserBtn w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-md font-medium transition duration-200">Simpan & Gunakan</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Connection -->
    <div class="mt-8 text-center">
      <div id="connectionStatus" class="inline-flex items-center px-4 py-2 rounded-full bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200">
        <span class="w-3 h-3 bg-gray-500 rounded-full mr-2"></span>
        <span>Menunggu koneksi...</span>
      </div>
    </div>

    <!-- Reset Configuration -->
    <div class="mt-4 text-center">
      <button id="resetConfig" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 underline">
        üîß Reset Konfigurasi Firebase
      </button>
    </div>
  </div>

  <!-- Alarm -->
  <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

  <script>
    // === 1Ô∏è‚É£ Inisialisasi Awal ===
    feather.replace();
    let firebaseInitialized = false;
    let db = null;

    // === 2Ô∏è‚É£ Fungsi untuk Test Koneksi Firebase ===
    async function testFirebaseConnection(config) {
      const testButton = document.getElementById('testConnection');
      const originalText = testButton.innerHTML;
      
      try {
        testButton.innerHTML = 'üîÑ Testing...';
        testButton.disabled = true;

        // Coba inisialisasi app sementara untuk test
        const testApp = firebase.initializeApp(config, 'TestApp_' + Date.now());
        const testDb = testApp.database();
        
        // Test write dan read
        const testRef = testDb.ref('connectionTest');
        const testData = { 
          timestamp: Date.now(), 
          test: true,
          message: 'Firebase connection test'
        };
        
        await testRef.set(testData);
        const snapshot = await testRef.once('value');
        const retrievedData = snapshot.val();
        
        // Hapus data test
        await testRef.remove();
        
        // Hapus app test
        testApp.delete();
        
        return {
          success: true,
          message: '‚úÖ Koneksi Firebase berhasil! Database bisa diakses.',
          data: retrievedData
        };
      } catch (error) {
        let errorMessage = '‚ùå Koneksi gagal: ';
        
        if (error.code === 'PERMISSION_DENIED') {
          errorMessage += 'PERMISSION_DENIED - Perbaiki Firebase Rules terlebih dahulu!';
        } else if (error.code === 'INVALID_CONFIG') {
          errorMessage += 'Konfigurasi Firebase tidak valid. Periksa kembali data yang dimasukkan.';
        } else {
          errorMessage += error.message;
        }
        
        return {
          success: false,
          message: errorMessage,
          error: error
        };
      } finally {
        testButton.innerHTML = originalText;
        testButton.disabled = false;
      }
    }

    // === 3Ô∏è‚É£ Fungsi untuk Inisialisasi Firebase ===
    function initializeFirebase(config) {
      try {
        // Hapus app existing jika ada
        try {
          const existingApp = firebase.app();
          if (existingApp) {
            existingApp.delete();
          }
        } catch (e) {
          // No existing app, continue
        }

        const app = firebase.initializeApp(config);
        db = app.database();
        firebaseInitialized = true;
        
        // Pastikan elemen ada sebelum memanipulasi
        const configPanel = document.getElementById('firebaseConfigPanel');
        const timerContainer = document.getElementById('timerContainer');
        
        if (configPanel && timerContainer) {
          configPanel.classList.add('hidden');
          timerContainer.classList.remove('hidden');
        } else {
          console.error('Element not found: firebaseConfigPanel or timerContainer');
          return false;
        }
        
        // Inisialisasi timer
        initTimers();
        
        return true;
      } catch (error) {
        console.error("Error initializing Firebase:", error);
        
        // Tampilkan error ke user
        const configPanel = document.getElementById('firebaseConfigPanel');
        if (configPanel) {
          configPanel.classList.remove('hidden');
        }
        
        alert("Error menginisialisasi Firebase: " + error.message);
        return false;
      }
    }

    // === 4Ô∏è‚É£ Fungsi untuk Load Konfigurasi dari LocalStorage ===
    function loadSavedConfig() {
      const savedConfig = localStorage.getItem('firebaseConfig');
      if (savedConfig) {
        try {
          const config = JSON.parse(savedConfig);
          // Isi form dengan config yang tersimpan
          document.getElementById('apiKey').value = config.apiKey || '';
          document.getElementById('authDomain').value = config.authDomain || '';
          document.getElementById('databaseURL').value = config.databaseURL || '';
          document.getElementById('projectId').value = config.projectId || '';
          document.getElementById('storageBucket').value = config.storageBucket || '';
          document.getElementById('messagingSenderId').value = config.messagingSenderId || '';
          document.getElementById('appId').value = config.appId || '';
        } catch (e) {
          console.error('Error loading saved config:', e);
        }
      }
    }

    // === 5Ô∏è‚É£ Event Listeners ===
    document.getElementById('saveConfig').addEventListener('click', async function() {
      const config = {
        apiKey: document.getElementById('apiKey').value.trim(),
        authDomain: document.getElementById('authDomain').value.trim(),
        databaseURL: document.getElementById('databaseURL').value.trim(),
        projectId: document.getElementById('projectId').value.trim(),
        storageBucket: document.getElementById('storageBucket').value.trim(),
        messagingSenderId: document.getElementById('messagingSenderId').value.trim(),
        appId: document.getElementById('appId').value.trim()
      };

      // Validasi config
      if (!config.apiKey || !config.databaseURL) {
        alert('API Key dan Database URL wajib diisi!');
        return;
      }

      // Test koneksi dulu
      const testResult = await testFirebaseConnection(config);
      if (!testResult.success) {
        alert(testResult.message);
        return;
      }

      // Simpan ke localStorage
      localStorage.setItem('firebaseConfig', JSON.stringify(config));
      
      // Initialize Firebase
      if (initializeFirebase(config)) {
        alert('‚úÖ Firebase berhasil diinisialisasi! Timer siap digunakan.');
      }
    });

    document.getElementById('testConnection').addEventListener('click', async function() {
      const config = {
        apiKey: document.getElementById('apiKey').value.trim(),
        authDomain: document.getElementById('authDomain').value.trim(),
        databaseURL: document.getElementById('databaseURL').value.trim(),
        projectId: document.getElementById('projectId').value.trim(),
        storageBucket: document.getElementById('storageBucket').value.trim(),
        messagingSenderId: document.getElementById('messagingSenderId').value.trim(),
        appId: document.getElementById('appId').value.trim()
      };

      if (!config.apiKey || !config.databaseURL) {
        alert('Isi API Key dan Database URL terlebih dahulu!');
        return;
      }

      const result = await testFirebaseConnection(config);
      alert(result.message);
    });

    // Reset configuration
    document.getElementById('resetConfig')?.addEventListener('click', function() {
      if (confirm('Yakin ingin reset konfigurasi Firebase? Semua data akan dihapus.')) {
        localStorage.removeItem('firebaseConfig');
        location.reload();
      }
    });

    // === 6Ô∏è‚É£ Fungsi Timer ===
    function initTimers() {
      const alarmSound = document.getElementById("alarmSound");
      const connectionStatus = document.getElementById("connectionStatus");

      if (!connectionStatus) {
        console.error('Connection status element not found');
        return;
      }

      // Monitor koneksi Firebase
      const connectedRef = db.ref(".info/connected");
      connectedRef.on("value", function(snap) {
        if (snap.val() === true) {
          connectionStatus.innerHTML = '<span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span><span>Terhubung ke Database</span>';
          connectionStatus.className = "inline-flex items-center px-4 py-2 rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";
        } else {
          connectionStatus.innerHTML = '<span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span><span>Terputus dari Database</span>';
          connectionStatus.className = "inline-flex items-center px-4 py-2 rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";
        }
      });

      function initTimer(containerId) {
        const container = document.getElementById(containerId);
        if (!container) {
          console.error('Timer container not found:', containerId);
          return null;
        }

        const timerDisplay = container.querySelector(".timer-display");
        const resetBtn = container.querySelector(".resetBtn");
        const settingsBtn = container.querySelector(".settingsBtn");
        const settingsPanel = container.querySelector(".settingsPanel");
        const usernameInput = container.querySelector(".usernameInput");
        const minutesInput = container.querySelector(".minutesInput");
        const saveUserBtn = container.querySelector(".saveUserBtn");
        const userLabel = container.querySelector(".userLabel");

        let username = localStorage.getItem("username_" + containerId) || "";
        let defaultTime = parseInt(localStorage.getItem("defaultTime_" + containerId)) || 15 * 60;
        let timerRef = null;
        let endTime = null;
        let localTimer = null;
        let alarmPlayed = false;

        function updateDisplay(sec) {
          if (!timerDisplay) return;
          
          const m = Math.floor(sec / 60);
          const s = sec % 60;
          timerDisplay.textContent = `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
          
          if (sec <= 10 && sec > 0) {
            timerDisplay.classList.add("text-red-500");
          } else if (sec === 0) {
            timerDisplay.classList.add("timer-ended");
          } else {
            timerDisplay.classList.remove("text-red-500", "timer-ended");
          }
        }

        function playAlarm() {
          if (alarmPlayed) return;
          alarmPlayed = true;
          
          if (alarmSound) {
            alarmSound.currentTime = 0;
            const playPromise = alarmSound.play();
            
            if (playPromise !== undefined) {
              playPromise.catch(error => {
                console.log("Autoplay diblokir:", error);
                if (timerDisplay) timerDisplay.classList.add("pulse-animation");
              });
            }
          }
          
          if (timerDisplay) timerDisplay.classList.add("pulse-animation");
          setTimeout(() => {
            if (timerDisplay) timerDisplay.classList.remove("pulse-animation");
          }, 6000);
        }

        function startLocalTimer() {
          clearInterval(localTimer);
          localTimer = setInterval(() => {
            const now = Date.now();
            const remaining = Math.max(0, Math.floor((endTime - now) / 1000));
            updateDisplay(remaining);
            
            if (remaining <= 0) {
              clearInterval(localTimer);
              playAlarm();
            }
          }, 1000);
        }

        function subscribeToUserTimer() {
          if (!username) return;
          
          // Bersihkan username dari karakter yang bermasalah
          const cleanUsername = username.replace(/[.#$\/\[\]]/g, '_');
          
          timerRef = db.ref("sharedTimers/" + cleanUsername);
          
          timerRef.on("value", (snap) => {
            const data = snap.val();
            if (!data) {
              resetTimer();
              return;
            }
            
            endTime = data.endTime;
            defaultTime = data.defaultTime;
            alarmPlayed = false;
            
            const remaining = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
            updateDisplay(remaining);
            startLocalTimer();
          });
          
          timerRef.once("value").then((snap) => {
            if (!snap.exists()) {
              resetTimer();
            }
          }).catch(error => {
            console.error("Error accessing database:", error);
            alert("Error mengakses database: " + error.message);
          });
        }

        function resetTimer() {
          if (!username) {
            alert("Masukkan username di Settings dulu!");
            return;
          }
          
          if (!timerRef) {
            alert("Timer belum terhubung ke database. Coba simpan settings lagi.");
            return;
          }
          
          const newEndTime = Date.now() + defaultTime * 1000;
          alarmPlayed = false;
          if (timerDisplay) timerDisplay.classList.remove("pulse-animation", "timer-ended", "text-red-500");
          
          timerRef.set({ 
            defaultTime: defaultTime, 
            endTime: newEndTime 
          }).then(() => {
            console.log("Timer reset successfully for user:", username);
          }).catch((error) => {
            console.error("Error resetting timer:", error);
            alert("Error resetting timer: " + error.message);
          });
        }

        if (saveUserBtn) {
          saveUserBtn.addEventListener("click", () => {
            username = usernameInput.value.trim().toLowerCase();
            const minutes = parseInt(minutesInput.value);
            
            if (!username) {
              alert("Masukkan username!");
              return;
            }
            
            // Validasi username
            if (username.includes(' ')) {
              alert("Username tidak boleh mengandung spasi. Gunakan underscore (_) sebagai pengganti.");
              return;
            }
            
            if (isNaN(minutes) || minutes < 1 || minutes > 120) {
              alert("Durasi tidak valid. Harus antara 1-120 menit.");
              return;
            }

            defaultTime = minutes * 60;
            localStorage.setItem("username_" + containerId, username);
            localStorage.setItem("defaultTime_" + containerId, defaultTime);
            if (userLabel) userLabel.textContent = `User: ${username}`;
            if (settingsPanel) settingsPanel.classList.add("hidden");
            
            subscribeToUserTimer();
          });
        }

        if (resetBtn) {
          resetBtn.addEventListener("click", resetTimer);
        }
        
        if (settingsBtn && settingsPanel && usernameInput && minutesInput) {
          settingsBtn.addEventListener("click", () => {
            settingsPanel.classList.toggle("hidden");
            usernameInput.value = username || "";
            minutesInput.value = Math.floor(defaultTime / 60);
          });
        }

        updateDisplay(defaultTime);
        if (username && userLabel) {
          userLabel.textContent = `User: ${username}`;
          subscribeToUserTimer();
        } else if (userLabel) {
          userLabel.textContent = "User belum diatur";
          if (settingsPanel) settingsPanel.classList.remove("hidden");
        }
        
        return {
          resetTimer,
          getUsername: () => username
        };
      }

      const timer1 = initTimer("timer1");
      const timer2 = initTimer("timer2");
      
      document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === '1') {
          event.preventDefault();
          if (timer1) timer1.resetTimer();
        }
        if (event.ctrlKey && event.key === '2') {
          event.preventDefault();
          if (timer2) timer2.resetTimer();
        }
      });
    }

    // === 7Ô∏è‚É£ Load saved config saat halaman dimuat ===
    document.addEventListener('DOMContentLoaded', function() {
      loadSavedConfig();
      feather.replace();
      
      // Jika config sudah ada di localStorage, coba initialize otomatis
      const savedConfig = localStorage.getItem('firebaseConfig');
      if (savedConfig) {
        try {
          const config = JSON.parse(savedConfig);
          if (config.apiKey && config.databaseURL) {
            // Tunggu sebentar agar DOM selesai load
            setTimeout(() => {
              if (initializeFirebase(config)) {
                console.log('Auto-initialized Firebase with saved config');
              }
            }, 100);
          }
        } catch (e) {
          console.error('Error auto-initializing Firebase:', e);
        }
      }
    });
  </script>
</body>
</html>
